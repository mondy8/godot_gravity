[gd_scene load_steps=18 format=3 uid="uid://d1sygjimchlkj"]

[ext_resource type="AudioStream" uid="uid://bw2ifd7rtbklw" path="res://music/00_iwashiro_sarusaru_music.mp3" id="1_4jahn"]
[ext_resource type="PackedScene" uid="uid://bkk87o2ooo6at" path="res://ui/overlays/fade_overlay.tscn" id="3_mkin4"]
[ext_resource type="Texture2D" uid="uid://b5g3f3hta8bnv" path="res://images/bg_white.png" id="4_ogkd6"]
[ext_resource type="PackedScene" uid="uid://jyv4g54adkmo" path="res://ui/overlays/pause_overlay.tscn" id="4_t2yfb"]
[ext_resource type="AudioStream" uid="uid://cdyw4oy12qlpi" path="res://music/歓声と拍手2.mp3" id="5_7o7ey"]
[ext_resource type="AudioStream" uid="uid://cfdre65jo3orq" path="res://music/スタジアムの拍手.mp3" id="6_840by"]
[ext_resource type="AudioStream" uid="uid://d33ruoa7ai7ro" path="res://music/スタジアムの歓声2.mp3" id="7_nyhwh"]
[ext_resource type="AudioStream" uid="uid://biy6xioiwn5ml" path="res://music/Motion-Swish02-1.mp3" id="8_psvit"]
[ext_resource type="PackedScene" uid="uid://c6ing7t585gyv" path="res://scenes/main/Player_pracitce.tscn" id="9_t26ro"]
[ext_resource type="PackedScene" uid="uid://cbu4up2afhwtn" path="res://scenes/main/Enemy_practice.tscn" id="10_p8nis"]
[ext_resource type="FontFile" uid="uid://b7bje77ycxb31" path="res://fonts/CP Font.otf" id="11_3eo7k"]

[sub_resource type="GDScript" id="GDScript_gossy"]
script/source = "extends Node2D
@onready var enemy01 = preload(\"res://scenes/main/Enemy_01_ball.tscn\")
@onready var enemySpawner = $EnemySpawner
@onready var playerSpawner = $PlayerSpawner
@onready var player = $Player
@onready var enemy = $Enemy
@onready var seesawGround = $Seesaw/SeesawGround
@onready var camera = $MainCamera
@onready var backButton = $BackButton
@onready var fade_overlay = %FadeOverlay

var is_game_set = false
var audio_bgm
var enemy_instance

# レベル変更シグナル
signal change_level(newLevel:String)
# タイマー操作シグナル
signal start_timer(control: bool)

func _ready() -> void:
	# playerからシーソーへ与えるシグナル
	player.seesaw_collided.connect(_on_seesaw_collided)
	# カメラシェイクシグナル
	player.camera_shake.connect(_on_camera_shake)
	# プレイヤーが落ちた時
	player.player_respawn.connect(_on_player_respawn)
	enemy.enemy_respawn.connect(_on_enemy_respawn)
	fade_overlay.visible = true
	backButton.grab_focus()
	fade_overlay.on_complete_fade_out.connect(_on_fade_overlay_on_complete_fade_out)
		
# シーソーへの衝突処理
func _on_seesaw_collided(collided_position:Vector2, impulse:Vector2):
	var seesawPosition = seesawGround.to_local(collided_position)
	seesawGround.apply_impulse(seesawPosition, impulse)

# プレイヤーが落ちた時の処理
func _on_player_respawn():
	PhysicsServer2D.body_set_state(
		player.get_rid(),
		PhysicsServer2D.BODY_STATE_TRANSFORM,
		Transform2D.IDENTITY.translated(playerSpawner.position)
	)
	player.set_freeze_enabled(false)
	Global.player_fall = false

# 敵が落ちた時の処理
func _on_enemy_respawn():
	PhysicsServer2D.body_set_state(
		enemy.get_rid(),
		PhysicsServer2D.BODY_STATE_TRANSFORM,
		Transform2D.IDENTITY.translated(enemySpawner.position)
	)
	enemy.set_freeze_enabled(false)
	Global.enemy_fall = false


# カメラシェイク
func _on_camera_shake(duration: float, magnitude: float) -> void:
	var tween = get_tree().create_tween()

	# duration秒かけてカメラを揺らす
	for i in range(int(duration * 10)):  # 10は更新頻度（1秒間に10回更新）
		var offset = Vector2(randf_range(-magnitude, magnitude), randf_range(-magnitude, magnitude))
		tween.tween_property(camera, \"offset\", Vector2(288, 162) + offset, 0.1)

	# 元の位置に戻す
	tween.tween_property(camera, \"offset\", Vector2(288, 162), 0.1)

func _on_back_button_pressed() -> void:
	fade_overlay.fade_out()

func _on_fade_overlay_on_complete_fade_out():
	get_tree().change_scene_to_file(\"res://scenes/main_menu_scene.tscn\")
"

[sub_resource type="PhysicsMaterial" id="PhysicsMaterial_2wi6t"]
friction = 0.5

[sub_resource type="RectangleShape2D" id="RectangleShape2D_juasp"]
size = Vector2(496, 27)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_iahn1"]
size = Vector2(8, 6)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_gepny"]
size = Vector2(18, 54)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_idcgh"]
size = Vector2(168.75, 6024)

[node name="PracitceScene" type="Node2D"]
script = SubResource("GDScript_gossy")

[node name="audio" type="Node2D" parent="."]

[node name="audioBGM" type="AudioStreamPlayer" parent="audio"]
stream = ExtResource("1_4jahn")
volume_db = -5.0
autoplay = true
bus = &"Music"

[node name="Game" type="Node2D" parent="."]
z_index = 1

[node name="TutorialText" type="CanvasLayer" parent="."]

[node name="text" type="Label" parent="TutorialText"]
offset_left = 13.0
offset_top = 11.0
offset_right = 576.0
offset_bottom = 88.0
text = "移動：十字キー / WASDキー
ジャンプ：上キー
ダッシュ：左右キーを二回連打
ヒップドロップ：ジャンプ中に下キー
"

[node name="UI" type="CanvasLayer" parent="."]
layer = 10

[node name="FadeOverlay" parent="UI" instance=ExtResource("3_mkin4")]
unique_name_in_owner = true
visible = false

[node name="PauseOverlay" parent="UI" instance=ExtResource("4_t2yfb")]
unique_name_in_owner = true
process_mode = 2
visible = false

[node name="Seesaw" type="Node2D" parent="."]
position = Vector2(-1, -25)

[node name="PinJoint2D" type="PinJoint2D" parent="Seesaw"]
position = Vector2(294, 220)
node_a = NodePath("../SeesawPin")
node_b = NodePath("../SeesawGround")

[node name="SeesawGround" type="RigidBody2D" parent="Seesaw"]
position = Vector2(294, 220)
mass = 50.0
physics_material_override = SubResource("PhysicsMaterial_2wi6t")

[node name="CollisionShape2D" type="CollisionShape2D" parent="Seesaw/SeesawGround"]
position = Vector2(0, -4.5)
shape = SubResource("RectangleShape2D_juasp")

[node name="Sprite2D" type="Sprite2D" parent="Seesaw/SeesawGround"]
modulate = Color(0.184314, 0.545098, 0.705882, 1)
position = Vector2(0, -4.75)
scale = Vector2(493, 26.5)
texture = ExtResource("4_ogkd6")

[node name="SeesawPin" type="StaticBody2D" parent="Seesaw"]
position = Vector2(297, 226)
metadata/_edit_group_ = true

[node name="Sprite2D" type="Sprite2D" parent="Seesaw/SeesawPin"]
modulate = Color(0.870588, 1, 1, 1)
position = Vector2(-2.99998, 74.5)
scale = Vector2(12, 167)
texture = ExtResource("4_ogkd6")

[node name="CollisionShape2D" type="CollisionShape2D" parent="Seesaw/SeesawPin"]
position = Vector2(-3, -6)
shape = SubResource("RectangleShape2D_iahn1")

[node name="Ground" type="StaticBody2D" parent="."]
modulate = Color(0.870588, 1, 1, 1)
position = Vector2(0, 307)

[node name="Sprite2D2" type="Sprite2D" parent="Ground"]
position = Vector2(472, 27)
scale = Vector2(18, 54)
texture = ExtResource("4_ogkd6")

[node name="Sprite2D" type="Sprite2D" parent="Ground"]
position = Vector2(120, 26.75)
scale = Vector2(20, 54.5)
texture = ExtResource("4_ogkd6")

[node name="CollisionShape2D2" type="CollisionShape2D" parent="Ground"]
position = Vector2(471, 27)
shape = SubResource("RectangleShape2D_gepny")

[node name="CollisionShape2D" type="CollisionShape2D" parent="Ground"]
position = Vector2(120, 27)
shape = SubResource("RectangleShape2D_gepny")

[node name="MainCamera" type="Camera2D" parent="."]
offset = Vector2(288, 162)

[node name="AudioClear1" type="AudioStreamPlayer" parent="."]
stream = ExtResource("5_7o7ey")
bus = &"Sound"

[node name="AudioLose" type="AudioStreamPlayer" parent="."]
stream = ExtResource("6_840by")
bus = &"Sound"

[node name="AudioWinner" type="AudioStreamPlayer" parent="."]
stream = ExtResource("7_nyhwh")
bus = &"Sound"

[node name="AudioLabelUI" type="AudioStreamPlayer" parent="."]
stream = ExtResource("8_psvit")
bus = &"Sound"

[node name="WallLeft" type="StaticBody2D" parent="."]
position = Vector2(-665.25, -20.5)

[node name="collsion" type="CollisionShape2D" parent="WallLeft"]
position = Vector2(-428.75, -2641.5)
shape = SubResource("RectangleShape2D_idcgh")

[node name="WallRight" type="StaticBody2D" parent="."]
position = Vector2(-665.25, -20.5)

[node name="collsion" type="CollisionShape2D" parent="WallRight"]
position = Vector2(2384.25, -2512.5)
shape = SubResource("RectangleShape2D_idcgh")

[node name="PlayerSpawner" type="Node2D" parent="."]
position = Vector2(176, -55)

[node name="EnemySpawner" type="Node2D" parent="."]
position = Vector2(452, -64)

[node name="Player" parent="." instance=ExtResource("9_t26ro")]

[node name="Enemy" parent="." instance=ExtResource("10_p8nis")]
position = Vector2(429, 77)

[node name="BackButton" type="Button" parent="."]
offset_left = 328.0
offset_top = 13.0
offset_right = 513.0
offset_bottom = 58.0
theme_override_fonts/font = ExtResource("11_3eo7k")
text = "メニューに戻る"

[connection signal="pressed" from="BackButton" to="." method="_on_back_button_pressed"]
